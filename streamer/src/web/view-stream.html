<!DOCTYPE html>
<html>
<head>
	<title>JSMpeg Stream Client</title>
	<style type="text/css">
		html, body {
			background-color: #000;
			text-align: center;
		}

		.video {
			width: 800px;
			height: 640px;
			background-color: #000;
			border: 1px solid gray;
			border-radius: 5px;
		}

		.controls {
			margin-top: 20px;
			display: flex;
			gap: 10px;
		}
	</style>
	
</head>
<body>
	<canvas class='video' id="video-canvas"></canvas>
	<script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
	<script type="text/javascript" src="web/jsmpeg.min.js"></script>
	<script type="text/javascript">

		class JSMpegWritableSource {
			constructor(url, options) {
				this.destination = null;
				this.completed = false;
				this.established = false;
				this.progress = 0;
				this.streaming = true;
			}

			connect(destination) {
				this.destination = destination;
			}

			start() {
				this.established = true;
				this.completed = true;
				this.progress = 1;
			}

			resume() {}

			destroy() {}

			write(data) {
				this.destination.write(data);
			}
		}

		var canvas = document.getElementById('video-canvas');
		var url = 'ws://'+document.location.hostname+':5454';
		var player = new JSMpeg.Player(null, {
			source: JSMpegWritableSource,
			audio: false,
			canvas: canvas,
		});

		console.log('connecting to ', url);

		var socket = io.connect(url);
		socket.on('connect', function() {
			console.log('connected', socket);
			socket.on('stream/frontcam', function (data) {
				if (!document.hidden) {
					player.source.write(data);
				} else {
					exitCam('frontcam')
				}
			});
			socket.on('stream/backcam', function (data) {
				if (!document.hidden) {
					player.source.write(data);
				} else {
					exitCam('backcam')
				}
			});
		});
		socket.on('disconnect', function() {
			console.log('connected');
		});

		function requestCam(stream_name) {
			socket.emit('request_stream', stream_name);
		}

		function exitCam(stream_name) {
			socket.emit('exit_stream', stream_name);
		}

	</script>
	<div class="controls">
		<button onclick="requestCam('frontcam')">Play 'frontcam'</button>
		<button onclick="exitCam('frontcam')">Pause 'frontcam'</button>
		<button onclick="requestCam('backcam')">Play 'backcam'</button>
		<button onclick="exitCam('backcam')">Pause 'backcam'</button>
	</div>
</body>
</html>
