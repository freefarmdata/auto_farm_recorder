<!DOCTYPE html>
<html>
<head>
	<title>JSMpeg Stream Client</title>
	<style type="text/css">
		html, body {
			background-color: #111;
			text-align: center;
		}
	</style>
	
</head>
<body>
	<canvas id="video-canvas"></canvas>
	<script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
	<script type="text/javascript" src="web/jsmpeg.min.js"></script>
	<script type="text/javascript">

		class JSMpegWritableSource {
			constructor(url, options) {
				this.destination = null;
				this.completed = false;
				this.established = false;
				this.progress = 0;
				this.streaming = true;
			}

			connect(destination) {
				this.destination = destination;
			}

			start() {
				this.established = true;
				this.completed = true;
				this.progress = 1;
			}

			resume() {}

			destroy() {}

			write(data) {
				this.destination.write(data);
			}
		}

		var canvas = document.getElementById('video-canvas');
		var url = 'ws://'+document.location.hostname+':5454';
		var player = new JSMpeg.Player(null, {
			source: JSMpegWritableSource,
			audio: false,
			canvas: canvas,
		});

		console.log('connecting to ', url);

		var socket = io.connect(url);
		socket.on('connect',function() {
			console.log('connected', socket);
			socket.on('stream/frontcam', function (data) {
				if (!document.hidden) {
					player.source.write(data);
				} else {
					exitCam('frontcam')
				}
			});
			socket.on('stream/backcam', function (data) {
				if (!document.hidden) {
					player.source.write(data);
				} else {
					exitCam('backcam')
				}
			});
		});
		socket.on('disconnect',function() {
			console.log('connected');
		});

		function requestCam(stream_name) {
			socket.emit('request_stream', stream_name);
		}

		function exitCam(stream_name) {
			socket.emit('exit_stream', stream_name);
		}

	</script>
	<div>
		<button onclick="requestCam('frontcam')">Request 'frontcam'</button>
		<button onclick="exitCam('frontcam')">Exit 'frontcam'</button>
		<button onclick="requestCam('backcam')">Request 'backcam'</button>
		<button onclick="exitCam('backcam')">Exit 'backcam'</button>
	</div>
</body>
</html>
