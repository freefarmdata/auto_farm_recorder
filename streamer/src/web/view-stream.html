<!DOCTYPE html>
<html>
<head>
	<title>JSMpeg Stream Client</title>
	<style type="text/css">
		html, body {
			background-color: #111;
			text-align: center;
		}
	</style>
	
</head>
<body>
	<canvas id="video-canvas"></canvas>
	<script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
	<script type="text/javascript" src="jsmpeg.min.js"></script>
	<script type="text/javascript">

		class JSMpegWritableSource {
			constructor(url, options) {
				this.destination = null;

				this.completed = false;
				this.established = false;
				this.progress = 0;

				// Streaming is obiously true when using a stream
				this.streaming = true;
			}

			connect(destination) {
				this.destination = destination;
			}

			start() {
				this.established = true;
				this.completed = true;
				this.progress = 1;
			}

			resume() { // eslint-disable-line class-methods-use-this

			}

			destroy() { // eslint-disable-line class-methods-use-this
			}

			write(data) {
				this.destination.write(data);
			}
		}

		var canvas = document.getElementById('video-canvas');
		var url = 'ws://'+document.location.hostname+':8082';
		var player = new JSMpeg.Player(null, {
			source: JSMpegWritableSource,
			audio: false,
			canvas: canvas,
		});

		// var player = new JSMpeg.Player('pipe', {canvas: canvas});
		var socket = io.connect('ws://'+document.location.hostname+':8082/');
		socket.on('connect',function() {
			console.log('connected', socket);
			socket.on('stream', function (data) {
				if (!document.hidden) {
					player.source.write(data);
				}
			});
		});
		socket.on('disconnect',function(){
			console.log('connected');
		});
		function onUpdateBuffer(value) {
			socket.emit('buffer', value);
		}
		
	</script>
	<div>
		<button onclick="onUpdateBuffer(1024)">1k</button>
		<button onclick="onUpdateBuffer(2*1024)">2k</button>
		<button onclick="onUpdateBuffer(4*1024)">4k</button>
		<button onclick="onUpdateBuffer(8*1024)">8k</button>
		<button onclick="onUpdateBuffer(16*1024)">16k</button>
		<button onclick="onUpdateBuffer(32*1024)">32k</button>
		<button onclick="onUpdateBuffer(64*1024)">64k</button>
		<button onclick="onUpdateBuffer(128*1024)">128k</button>
		<button onclick="onUpdateBuffer(256*1024)">256k</button>
		<button onclick="onUpdateBuffer(512*1024)">512k</button>
		<button onclick="onUpdateBuffer(1024*1024)">1024k</button>
	</div>
</body>
</html>
